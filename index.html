import React, { useState, useEffect, useCallback, useRef } from 'react';
import { Trophy, Brain, ChevronRight, CheckCircle2, Layout, ChevronLeft, Boxes, XCircle, Zap, Clock, Activity, Volume2, Plus, Minus, Play } from 'lucide-react';

const App = () => {
  const [gameState, setGameState] = useState('home'); // home, setup, playing, result
  const [selectedDifficulty, setSelectedDifficulty] = useState(null);
  const [initialTime, setInitialTime] = useState(30);
  const [score, setScore] = useState(0);
  const [timeLeft, setTimeLeft] = useState(0);
  const [feedback, setFeedback] = useState(null);
  const [stats, setStats] = useState({ correct: 0, total: 0 });
  const [currentTask, setCurrentTask] = useState(null);

  const DIFFICULTIES = {
    1: { id: 1, name: "Level 1", desc: "Basic connections.", maxTime: 30, icon: <Brain />, color: "text-pink-500", border: "border-pink-500/20", glow: "shadow-pink-500/20" },
    2: { id: 2, name: "Level 2", desc: "Complex groupings.", maxTime: 20, icon: <Layout />, color: "text-cyan-400", border: "border-cyan-400/20", glow: "shadow-cyan-400/20" },
    3: { id: 3, name: "Level 3", desc: "Abstract systems.", maxTime: 10, icon: <Boxes />, color: "text-purple-500", border: "border-purple-500/20", glow: "shadow-purple-500/20" }
  };

  const generateTask = useCallback((difficultyId) => {
    const types = ['bridge', 'enclosure', 'pipeline', 'neural', 'tab', 'card', 'circuit', 'grid', 'orbit'];
    const type = types[Math.floor(Math.random() * types.length)];
    const isConnected = Math.random() > 0.5;
    const hue = Math.floor(Math.random() * 360);
    
    return {
      id: Math.random().toString(36).substr(2, 9),
      type,
      isConnected,
      hue,
      rotation: Math.floor(Math.random() * 4) * 90,
      shape: Math.random() > 0.5 ? 'rounded-full' : 'rounded-2xl',
      complexity: difficultyId
    };
  }, []);

  const handleLevelSelect = (diffId) => {
    const diff = DIFFICULTIES[diffId];
    setSelectedDifficulty(diff);
    setInitialTime(diff.maxTime); // Start at max time
    setGameState('setup');
  };

  const adjustTime = (amount) => {
    if (!selectedDifficulty) return;
    // Clamp between 5 and the level's specific maxTime
    setInitialTime(prev => Math.max(5, Math.min(selectedDifficulty.maxTime, prev + amount)));
  };

  const startGame = () => {
    setScore(0);
    setStats({ correct: 0, total: 0 });
    setFeedback(null);
    setCurrentTask(generateTask(selectedDifficulty.id));
    setTimeLeft(initialTime);
    setGameState('playing');
  };

  const handleAnswer = useCallback((userAnswerIsConnected) => {
    if (feedback || !currentTask) return;

    const isCorrect = userAnswerIsConnected === currentTask.isConnected;

    setFeedback(isCorrect ? 'correct' : 'wrong');
    setStats(prev => ({ 
      total: prev.total + 1, 
      correct: isCorrect ? prev.correct + 1 : prev.correct 
    }));
    
    if (isCorrect) {
      const difficultyPoints = selectedDifficulty.id * 50;
      setScore(prev => prev + 100 + difficultyPoints);
    } else {
      setTimeLeft(prev => Math.max(0, prev - 2)); 
    }

    setTimeout(() => {
      setFeedback(null);
      setCurrentTask(generateTask(selectedDifficulty.id));
    }, 400); 
  }, [feedback, currentTask, selectedDifficulty, generateTask]);

  // Continuous Timer Logic
  useEffect(() => {
    let timer;
    if (gameState === 'playing' && timeLeft > 0) {
      timer = setInterval(() => {
        setTimeLeft(prev => {
          if (prev <= 0.1) {
            setGameState('result');
            return 0;
          }
          return prev - 0.1;
        });
      }, 100);
    } else if (timeLeft <= 0 && gameState === 'playing') {
      setGameState('result');
    }
    return () => clearInterval(timer);
  }, [gameState, timeLeft]);

  // Visual Engine 
  const VisualRenderer = ({ task }) => {
    if (!task) return null;
    const { type, isConnected, hue, shape } = task;
    const primary = `hsl(${hue}, 90%, 60%)`;
    const glow = `0 0 20px hsl(${hue}, 90%, 50%, 0.5)`;
    
    const renderGraphic = () => {
      switch (type) {
        case 'bridge': return (
          <div className="flex items-center gap-24 relative">
            <div className={`w-20 h-20 ${shape} border-4 bg-slate-900 z-10`} style={{ borderColor: primary, boxShadow: glow }} />
            <div className="absolute left-1/2 top-1/2 -translate-x-1/2 -translate-y-1/2 w-full flex justify-center items-center">
              {isConnected && <div className="h-6 w-32 rounded-full animate-pulse z-0" style={{ backgroundColor: primary, boxShadow: glow }} />}
            </div>
            <div className={`w-20 h-20 ${shape} border-4 bg-slate-900 z-10`} style={{ borderColor: primary, boxShadow: glow }} />
          </div>
        );
        case 'enclosure': return (
          <div className={`p-12 rounded-[3rem] flex gap-8 transition-all duration-300 ${isConnected ? 'bg-slate-800/50 border-4' : 'bg-transparent border-4 border-transparent'}`} style={{ borderColor: isConnected ? primary : 'transparent', boxShadow: isConnected ? glow : 'none' }}>
            <div className={`w-16 h-16 ${shape}`} style={{ backgroundColor: primary, opacity: 0.8 }} />
            <div className={`w-16 h-16 ${shape}`} style={{ backgroundColor: primary, opacity: 0.8 }} />
          </div>
        );
        case 'pipeline': return (
          <div className="flex flex-col items-center gap-2">
            <div className="w-32 h-14 rounded-xl border-4 bg-slate-900" style={{ borderColor: primary }} />
            {isConnected ? <div className="w-12 h-20 transition-all duration-300" style={{ backgroundColor: primary, boxShadow: glow }} /> : <div className="w-12 h-20"></div>}
            <div className="w-32 h-14 rounded-xl border-4 bg-slate-900" style={{ borderColor: primary }} />
          </div>
        );
        case 'neural': return (
          <div className="relative w-64 h-48">
            <svg className="absolute inset-0 w-full h-full overflow-visible">
              {isConnected && (
                <>
                  <path d="M128 30 L40 160" stroke={primary} strokeWidth="8" strokeLinecap="round" style={{ filter: `drop-shadow(${glow})` }} />
                  <path d="M128 30 L216 160" stroke={primary} strokeWidth="8" strokeLinecap="round" style={{ filter: `drop-shadow(${glow})` }} />
                </>
              )}
            </svg>
            <div className="absolute top-0 left-1/2 -translate-x-1/2 w-12 h-12 rounded-full bg-slate-950 border-4 z-10" style={{ borderColor: primary }} />
            <div className="absolute bottom-0 left-4 w-14 h-14 rounded-full bg-slate-950 border-4 z-10" style={{ borderColor: primary }} />
            <div className="absolute bottom-0 right-4 w-14 h-14 rounded-full bg-slate-950 border-4 z-10" style={{ borderColor: primary }} />
          </div>
        );
        
        // --- UPDATED TAB VISUAL ---
        case 'tab': return (
          <div className="flex flex-col items-center justify-center gap-1">
             <div className="flex gap-4 items-end">
                {/* Left Tab */}
                <div className="w-20 h-24 bg-slate-900 border-4 border-b-0 rounded-t-2xl flex items-center justify-center relative" style={{ borderColor: primary, boxShadow: glow }}>
                   <div className="w-8 h-2 rounded-full opacity-50" style={{ backgroundColor: primary }}></div>
                </div>
                {/* Right Tab */}
                <div className="w-20 h-24 bg-slate-900 border-4 border-b-0 rounded-t-2xl flex items-center justify-center relative" style={{ borderColor: primary, boxShadow: glow }}>
                   <div className="w-8 h-2 rounded-full opacity-50" style={{ backgroundColor: primary }}></div>
                </div>
             </div>
             {/* The Connection Line */}
             <div className="flex items-center gap-4">
                 <div className={`h-4 rounded-full transition-all duration-300 ${isConnected ? 'w-44' : 'w-20'}`} style={{ backgroundColor: primary, boxShadow: glow }}></div>
                 {!isConnected && <div className="w-20 h-4 rounded-full" style={{ backgroundColor: primary, boxShadow: glow }}></div>}
             </div>
          </div>
        );

        // --- UPDATED CARD VISUAL ---
        case 'card': return (
           <div className="flex items-center justify-center gap-8 h-64">
              {/* Card 1 */}
              <div className={`w-32 h-48 border-4 bg-slate-900 rounded-xl flex items-center justify-center transition-all duration-500 ${isConnected ? 'rotate-12 translate-x-4' : 'rotate-0 -translate-x-4'}`} style={{ borderColor: primary, boxShadow: glow }}>
                  <div className="w-20 h-2 rounded-full opacity-30" style={{ backgroundColor: primary }}></div>
              </div>

              {/* Connection Link */}
              {isConnected && (
                  <div className="absolute w-24 h-4 z-20 animate-pulse rounded-full" style={{ backgroundColor: primary, boxShadow: glow }}></div>
              )}

              {/* Card 2 */}
              <div className={`w-32 h-48 border-4 bg-slate-900 rounded-xl flex items-center justify-center transition-all duration-500 ${isConnected ? '-rotate-12 -translate-x-4' : 'rotate-0 translate-x-4'}`} style={{ borderColor: primary, boxShadow: glow }}>
                   <div className="w-20 h-2 rounded-full opacity-30" style={{ backgroundColor: primary }}></div>
              </div>
           </div>
        );

        case 'circuit': return (
           <div className="flex items-center gap-2">
              <div className="w-20 h-20 border-4 bg-slate-900 rounded-lg z-10" style={{ borderColor: primary }}></div>
              {isConnected ? <div className="h-4 w-32 z-0" style={{ backgroundColor: primary, boxShadow: glow }}></div> : <div className="h-4 w-32 bg-transparent"></div>}
              <div className="w-20 h-20 border-4 bg-slate-900 rounded-lg z-10" style={{ borderColor: primary }}></div>
           </div>
        );
        case 'grid': return (
            <div className={`grid grid-cols-2 gap-4 p-4 rounded-3xl transition-all ${isConnected ? 'gap-0 bg-slate-800 border-2' : 'gap-10 border-0'}`} style={{ borderColor: isConnected ? primary : 'transparent' }}>
               <div className="w-12 h-12 rounded bg-slate-700" style={{ backgroundColor: primary }}></div>
               <div className="w-12 h-12 rounded bg-slate-700" style={{ backgroundColor: primary }}></div>
               <div className="w-12 h-12 rounded bg-slate-700" style={{ backgroundColor: primary }}></div>
               <div className="w-12 h-12 rounded bg-slate-700" style={{ backgroundColor: primary }}></div>
            </div>
         );
        default: return (
          <div className="flex flex-col items-center gap-6">
             <div className="flex gap-16">
               <div className="w-16 h-16 rounded-full border-4" style={{ borderColor: primary }} />
               <div className="w-16 h-16 rounded-full border-4" style={{ borderColor: primary }} />
             </div>
             {isConnected ? <div className="w-48 h-2 rounded-full" style={{ backgroundColor: primary, boxShadow: glow }}></div> : <div className="w-48 h-2 bg-transparent"></div>}
          </div>
        );
      }
    };

    return (
      <div className="w-full h-80 bg-slate-950 rounded-[3rem] flex items-center justify-center relative border-4 border-slate-800 shadow-[inset_0_0_40px_rgba(0,0,0,0.5)] overflow-hidden group transition-all duration-300">
        <div className="absolute inset-0 bg-[url('https://www.transparenttextures.com/patterns/carbon-fibre.png')] opacity-10 pointer-events-none"></div>
        <div className="absolute top-6 left-8 text-[10px] font-black text-slate-700 tracking-[0.3em] uppercase z-20">System: {type}</div>
        <div className="absolute inset-0 opacity-10 pointer-events-none" style={{ background: `radial-gradient(circle at center, ${primary}, transparent 70%)` }}></div>
        <div className="relative z-10 scale-90 group-hover:scale-100 transition-transform duration-500">
           {renderGraphic()}
        </div>
      </div>
    );
  };

  return (
    <div className="min-h-screen bg-slate-950 font-sans text-slate-100 p-4 flex items-center justify-center selection:bg-purple-500/30">
      <div className="max-w-md w-full bg-slate-900 rounded-[3.5rem] shadow-2xl p-8 border-8 border-slate-800 relative overflow-hidden min-h-[850px] flex flex-col">
        <div className="absolute top-0 left-0 w-full h-64 bg-gradient-to-b from-slate-800/50 to-transparent pointer-events-none" />
        
        {/* --- HOME SCREEN --- */}
        {gameState === 'home' && (
          <div className="flex-1 flex flex-col items-center justify-center text-center py-6 animate-in fade-in zoom-in-95 duration-500">
            <div className="w-32 h-32 bg-slate-800 rounded-[2.5rem] flex items-center justify-center shadow-2xl mb-8 border border-slate-700 relative group">
              <div className="absolute inset-0 bg-purple-500/20 rounded-[2.5rem] blur-xl group-hover:blur-2xl transition-all"></div>
              <Activity className="text-purple-400 w-16 h-16 relative z-10" />
            </div>
            <h1 className="text-4xl font-black text-white tracking-tight mb-2 uppercase">Connected<br/><span className="text-purple-500">or Isolated?</span></h1>
            <p className="text-slate-400 text-sm font-medium mb-12 tracking-wide">VISUAL PERCEPTION ENGINE</p>
            
            <div className="w-full space-y-4 px-2">
              {Object.values(DIFFICULTIES).map(diff => (
                <button key={diff.id} onClick={() => handleLevelSelect(diff.id)} className={`w-full p-6 bg-slate-800 rounded-[2rem] flex items-center gap-5 hover:bg-slate-750 transition-all active:scale-95 group border-2 border-transparent hover:border-slate-600 relative overflow-hidden`}>
                  <div className={`w-12 h-12 rounded-xl bg-slate-900 flex items-center justify-center ${diff.color} shadow-lg ring-1 ring-white/10`}>
                    {React.cloneElement(diff.icon, { size: 24 })}
                  </div>
                  <div className="text-left flex-1 relative z-10">
                    <p className={`font-bold text-white text-lg group-hover:${diff.color} transition-colors`}>{diff.name}</p>
                    <p className="text-[10px] text-slate-500 font-bold tracking-widest uppercase">{diff.desc}</p>
                  </div>
                  <ChevronRight className="text-slate-600 group-hover:text-white transition-colors" />
                </button>
              ))}
            </div>
          </div>
        )}

        {/* --- SETUP (SLIDER) SCREEN --- */}
        {gameState === 'setup' && selectedDifficulty && (
           <div className="flex-1 flex flex-col pt-4 animate-in slide-in-from-right-8 duration-300">
              <button onClick={() => setGameState('home')} className="self-start p-3 bg-slate-800 rounded-full text-slate-400 hover:text-white mb-6 hover:bg-slate-700 transition-colors">
                <ChevronLeft size={24} />
              </button>
              
              <div className="text-center mb-10">
                <p className={`text-xs font-bold uppercase tracking-[0.2em] mb-2 ${selectedDifficulty.color}`}>{selectedDifficulty.name}</p>
                <h2 className="text-3xl font-black text-white">Adjust Duration</h2>
                <p className="text-slate-500 text-sm mt-2 px-8">Set your starting time. Max: {selectedDifficulty.maxTime}s.</p>
              </div>

              {/* Volume-style Slider UI */}
              <div className="flex-1 flex flex-col items-center justify-center w-full px-4 mb-10">
                 <div className="w-full bg-slate-800 rounded-[3rem] p-8 flex flex-col items-center shadow-inner relative overflow-hidden border border-slate-700">
                    {/* Background glow based on time */}
                    <div className={`absolute bottom-0 left-0 right-0 bg-${selectedDifficulty.color.split('-')[1]}-500/10 transition-all duration-300`} style={{ height: `${(initialTime/selectedDifficulty.maxTime)*100}%` }}></div>
                    
                    <div className="text-6xl font-black text-white mb-2 z-10 tabular-nums">{initialTime}s</div>
                    <div className="text-xs font-bold text-slate-500 uppercase tracking-widest z-10 mb-8">Starting Time</div>

                    <div className="w-full flex items-center gap-6 z-10">
                       <button onClick={() => adjustTime(-5)} className="w-12 h-12 rounded-full bg-slate-900 flex items-center justify-center text-slate-400 hover:text-white hover:bg-slate-700 transition-all active:scale-90">
                          <Minus size={20} />
                       </button>
                       <div className="flex-1 relative h-16 flex items-center">
                          {/* Custom Slider Input */}
                          <input 
                             type="range" 
                             min="5" 
                             max={selectedDifficulty.maxTime} 
                             step="1"
                             value={initialTime} 
                             onChange={(e) => setInitialTime(Number(e.target.value))}
                             className="w-full absolute z-20 opacity-0 cursor-pointer h-full"
                          />
                          {/* Visual Track */}
                          <div className="w-full h-4 bg-slate-900 rounded-full overflow-hidden relative">
                             <div 
                                className={`h-full transition-all duration-100 bg-white`} 
                                style={{ width: `${((initialTime - 5) / (selectedDifficulty.maxTime - 5)) * 100}%` }}
                             />
                          </div>
                          {/* Visual Thumb */}
                          <div 
                             className="w-8 h-8 bg-white rounded-full shadow-lg absolute pointer-events-none transition-all duration-100 flex items-center justify-center"
                             style={{ left: `calc(${((initialTime - 5) / (selectedDifficulty.maxTime - 5)) * 100}% - 16px)` }}
                          >
                             <div className={`w-3 h-3 rounded-full bg-${selectedDifficulty.color.split('-')[1]}-500`}></div>
                          </div>
                       </div>
                       <button onClick={() => adjustTime(5)} className="w-12 h-12 rounded-full bg-slate-900 flex items-center justify-center text-slate-400 hover:text-white hover:bg-slate-700 transition-all active:scale-90">
                          <Plus size={20} />
                       </button>
                    </div>
                 </div>
              </div>

              <button onClick={startGame} className="w-full py-6 bg-white text-slate-950 rounded-[2.5rem] font-black text-xl shadow-[0_0_40px_rgba(255,255,255,0.3)] hover:shadow-[0_0_60px_rgba(255,255,255,0.5)] active:scale-95 transition-all flex items-center justify-center gap-3">
                 <Play fill="currentColor" /> START SESSION
              </button>
           </div>
        )}

        {/* --- PLAYING SCREEN --- */}
        {gameState === 'playing' && (
          <div className="flex-1 flex flex-col space-y-6 py-2 animate-in fade-in duration-500">
            {/* Header */}
            <div className="flex justify-between items-center bg-slate-800/50 p-2 rounded-full backdrop-blur-sm relative">
              <button onClick={() => setGameState('home')} className="p-3 bg-slate-800 rounded-full text-slate-400 hover:text-white transition-colors">
                <ChevronLeft size={20} />
              </button>
              <div className="flex items-center gap-2">
                 <Zap size={14} className="text-yellow-400 fill-yellow-400" />
                 <span className="font-black text-lg text-white tabular-nums tracking-tight">{score}</span>
              </div>
              
              {/* Timer Display */}
              <div className={`relative w-20 h-10 flex items-center justify-center rounded-full font-black text-lg tabular-nums transition-colors ${timeLeft <= 5 ? 'bg-red-500/20 text-red-400 animate-pulse' : 'bg-slate-800 text-slate-200'}`}>
                 {timeLeft.toFixed(1)}s
              </div>
            </div>

            {/* Game Area */}
            <div className="relative flex-1 flex flex-col justify-center">
              <VisualRenderer task={currentTask} />
              
              {feedback && (
                <div className="absolute inset-0 flex items-center justify-center z-50 animate-in fade-in zoom-in-90 duration-200">
                   <div className={`absolute inset-0 bg-slate-950/80 backdrop-blur-sm rounded-[3rem]`}></div>
                   {feedback === 'correct' ? (
                    <div className="relative flex flex-col items-center">
                      <div className="w-24 h-24 bg-green-500 rounded-full flex items-center justify-center shadow-[0_0_50px_rgba(34,197,94,0.5)] animate-bounce">
                         <CheckCircle2 className="w-12 h-12 text-slate-950" />
                      </div>
                      <p className="mt-4 font-black text-green-400 text-xl tracking-widest uppercase">Correct</p>
                    </div>
                  ) : (
                    <div className="relative flex flex-col items-center">
                      <div className="w-24 h-24 bg-red-500 rounded-full flex items-center justify-center shadow-[0_0_50px_rgba(239,68,68,0.5)] animate-pulse">
                         <XCircle className="w-12 h-12 text-white" />
                      </div>
                       <p className="mt-4 font-black text-red-400 text-xl tracking-widest uppercase">Missed</p>
                    </div>
                  )}
                </div>
              )}
            </div>

            {/* Controls */}
            <div className="grid grid-cols-2 gap-4 mt-auto">
              <button disabled={!!feedback} onClick={() => handleAnswer(true)} className="h-24 bg-slate-800 hover:bg-slate-700 text-white rounded-[2rem] font-black text-lg shadow-lg border-b-4 border-slate-950 active:border-b-0 active:translate-y-1 transition-all flex flex-col items-center justify-center gap-2 group">
                <div className="w-8 h-1 bg-green-500 rounded-full shadow-[0_0_10px_rgba(34,197,94,0.8)] group-hover:w-12 transition-all"></div>
                LINKED
              </button>
              <button disabled={!!feedback} onClick={() => handleAnswer(false)} className="h-24 bg-slate-800 hover:bg-slate-700 text-white rounded-[2rem] font-black text-lg shadow-lg border-b-4 border-slate-950 active:border-b-0 active:translate-y-1 transition-all flex flex-col items-center justify-center gap-2 group">
                 <div className="flex gap-1 group-hover:gap-3 transition-all">
                    <div className="w-2 h-2 bg-red-500 rounded-full shadow-[0_0_10px_rgba(239,68,68,0.8)]"></div>
                    <div className="w-2 h-2 bg-red-500 rounded-full shadow-[0_0_10px_rgba(239,68,68,0.8)]"></div>
                 </div>
                ISOLATED
              </button>
            </div>
          </div>
        )}

        {/* --- RESULT SCREEN --- */}
        {gameState === 'result' && (
          <div className="flex-1 flex flex-col items-center justify-center text-center py-10 space-y-8 animate-in zoom-in-95 duration-500">
            <div className="relative">
               <div className="absolute inset-0 bg-yellow-400 blur-3xl opacity-20 rounded-full animate-pulse"></div>
               <Trophy className="w-28 h-28 text-yellow-400 relative z-10 drop-shadow-2xl" />
            </div>
            
            <div>
              <p className="text-xs font-bold text-slate-500 uppercase tracking-[0.3em] mb-2">Session Complete</p>
              <h2 className="text-7xl font-black text-white tracking-tighter mb-1 drop-shadow-2xl">{score}</h2>
            </div>

            <div className="w-full bg-slate-800 p-6 rounded-[2.5rem] grid grid-cols-2 gap-4 border border-slate-700">
              <div className="bg-slate-900/50 p-4 rounded-3xl">
                <p className="text-[10px] font-black text-slate-500 uppercase tracking-widest mb-1">Precision</p>
                <p className="text-2xl font-black text-white">{stats.total > 0 ? Math.round((stats.correct/stats.total)*100) : 0}%</p>
              </div>
              <div className="bg-slate-900/50 p-4 rounded-3xl">
                <p className="text-[10px] font-black text-slate-500 uppercase tracking-widest mb-1">Correct</p>
                <p className="text-2xl font-black text-white">{stats.correct}/{stats.total}</p>
              </div>
            </div>

            <button onClick={() => setGameState('home')} className="w-full py-6 bg-purple-600 hover:bg-purple-500 text-white rounded-[2.5rem] font-black text-xl shadow-[0_10px_40px_-10px_rgba(147,51,234,0.5)] active:scale-95 transition-all">
              PLAY AGAIN
            </button>
          </div>
        )}
      </div>
    </div>
  );
};

export default App;
